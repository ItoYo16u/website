---
path: "scala-3-compile-time-macro"
date: "20210211"
title: "Scala 3ã®ãƒã‚¯ãƒ­ã§compileæ™‚ã«ASTã‚’æ“ä½œã™ã‚‹"
description: "..."
status: "draft"
tags: ["Scala"]
---

# About
ã—ã«ã‚ƒã„ã•ã‚“ã®[ã“ã®è¨˜äº‹](https://shinyaigeek.dev/post/introduction-to-AST)ã‚’èª­ã‚“ã§
JSã§ã‚‚ASTæ“ä½œã§ãã‚‹ã®ã‹ï½ã¨æ„Ÿå¿ƒã—ãŸã®ã§Scala2ã®ãƒã‚¯ãƒ­ã«è§¦ã‚Œã¤ã¤Scala 3ã§å°å…¥ã•ã‚ŒãŸcompileæ™‚ã®macroã‚’ç´¹ä»‹ã™ã‚‹.

## AST(Abstract Syntax Tree)ã¨ã¯
ã“ã‚Œã¯ã•ã£ãã®ãƒ–ãƒ­ã‚°ã«ã‚‚æ›¸ã„ã¦ã‚ã‚‹ãŒãƒ—ãƒ­ã‚°ãƒ©ãƒ ã®æ§‹é€ ã‚’æœ¨æ§‹é€ ã§è¡¨ç¾ã—ãŸã‚„ã¤.

Scalaã§ã¯ã€ä¾‹ãˆã°`x < 10`ã¨ã„ã†å¼ã¯æ¬¡ã®ã‚ˆã†ãªæ§‹é€ ã‚’ã‚‚ã¤.

```scala
Apply(
  Select(
    Indent(
      TermName("x")
      ),
      TermName("$less")
  ),
  List(
    Literal(
      Constant(10)
    )
  )
)
```


ãƒã‚¯ãƒ­ã¯Scala 2ã§experimentalã«å°å…¥ã•ã‚Œã¦`slick`ã‚„ã‚‰`??`ã‚„ã‚‰ã„ã‚ã‚“ãªãƒ©ã‚¤ãƒ–ãƒ©ãƒªã§ä½¿ã‚ã‚Œã¦ã„ã‚‹.

Scalaã®ãƒã‚¯ãƒ­ã®ä¸–ç•Œã«ã¯`universe`ã‚„`mirror`ã¨ã„ã†æ¦‚å¿µãŒã‚ã‚‹ã®ã§é †ã‚’ãŠã£ã¦ç°¡å˜ã«èª¬æ˜ã—ã¦ãŠã.



### universe
å¤‰æ•°ã€é–¢æ•°ã‚„å‹æƒ…å ±ã®é›†åˆã®ã“ã¨
runtime universeã¨compile time universeãŒã‚ã‚Šã€ãã‚Œãã‚Œå®Ÿè¡Œæ™‚ã®å¤‰æ•°ã‚„å‹ã®æƒ…å ±ã€ã‚³ãƒ³ãƒ‘ã‚¤ãƒ«æ™‚ã®å¤‰æ•°ã‚„å‹ã®æƒ…å ±ã‚’æŒã£ã¦ã„ã‚‹ã€‚

compile time universeã¯äº‹å‰ã«ç”¨æ„ã•ã‚ŒãŸä¾¿åˆ©æ©Ÿèƒ½ã‚’ä½¿ã†ãŸã‚ã«Scala2ç³»ã§ã¯`scala.reflect.macros.Context`ã€3ç³»ã§ã¯`Quotes`ã«ãƒ©ãƒƒãƒ—ã•ã‚ŒãŸã‚‚ã®ã‚’ä½¿ã†ã€‚
### mirror
universeã«å«ã¾ã‚Œã‚‹æƒ…å ±ã‚’å†™ã—å–ã£ã¦ASTã‚’ã‚´ãƒ‹ãƒ§ã‚´ãƒ‹ãƒ§æ“ä½œã™ã‚‹ãŸã‚ã«ä½¿ã†.

Scala2ç³»ã®è©±ã ãŒã“ã®è¨˜äº‹ãŒå‚è€ƒã«ãªã‚‹ 

https://itakeshi.hatenablog.com/entry/2017/12/23/002550#%E3%82%B3%E3%83%B3%E3%83%91%E3%82%A4%E3%83%AB%E6%99%82%E3%83%AA%E3%83%95%E3%83%AC%E3%82%AF%E3%82%B7%E3%83%A7%E3%83%B3-%E3%82%B3%E3%83%B3%E3%83%86%E3%82%AD%E3%82%B9%E3%83%88%E3%81%A8macro%E3%82%AD%E3%83%BC%E3%83%AF%E3%83%BC%E3%83%89

## Scala3ã®ãƒã‚¯ãƒ­


ã“ã‚Œã‚‚å…ˆã«æŒ™ã’ãŸãƒ–ãƒ­ã‚°ã«æ›¸ã„ã¦ã‚ã‚‹ãŒJavaScriptã®ASTæ“ä½œã§ã¯`@babel/parser`ã‚’ä½¿ã£ã¦ã‚³ãƒ¼ãƒ‰ã®æ–‡å­—åˆ—ã‚’parse(reify)ã—
"@babel/traverse"ã§ASTã‚’èµ°æŸ»ã—ã¦ç·¨é›†ã—ãŸã„ASTã‚’å¤‰æ›ã—
`@babel/generator`ã‚’ä½¿ã£ã¦ASTã‹ã‚‰ã‚³ãƒ¼ãƒ‰ã‚’ç”Ÿæˆã™ã‚‹ã‚‰ã—ã„ã€‚


```javascript
const { parse } = require("@babel/parser");
const { default: generate } = require("@babel/generator");
const { default: traverse } = require("@babel/traverse");
const code = `
if(hoge === "bar") {
  fuga();
}
`
const ast = parser(code); // code => ast
const visitor = {}
traverse(ast,visitor); // visitorã¨ã„ã†æ¦‚å¿µã‚’ä½¿ã£ã¦ç‰¹å®šã®Nodeã¸ã®å‡¦ç†ã‚’è¨˜è¿°ã™ã‚‹
const { code: output } = generate(ast); //ast => code
console.log(output)
```


Scalaã®ãƒã‚¯ãƒ­ã§ã¯ã€ä¼¼ãŸã‚ˆã†ãªã“ã¨ã‚’ã™ã‚‹ãŸã‚ã«æŠ½è±¡æ§‹æ–‡æœ¨ã‚’æŠ½è±¡åŒ–ã—ãŸ`Expr`ã‚’ã‚³ãƒ¼ãƒ‰ã‹ã‚‰ã¨ã‚Šã ã™`quote`(ãƒãƒƒã‚¯ã‚¯ã‚ªãƒ¼ãƒˆã§è¡¨ç¾ã™ã‚‹)ã¨
`Expr`ã‚’è©•ä¾¡ã™ã‚‹`splicing`(`${expr}`ã§è¡¨ç¾ã™ã‚‹)ã®çµ„ã¿åˆã‚ã›ã‚’ä½¿ã†.

`parser(code)`ãŒ`quote`ã€`genarete(ast)`ãŒ`splicing`ã¨è€ƒãˆã¦ã¿ã‚‹ã¨ã‚ã‹ã‚Šã‚„ã™ã„.

`quote`,`splicing`ã‚’ä½¿ã£ãŸãƒã‚¯ãƒ­ã¯ã‚³ãƒ³ãƒ‘ã‚¤ãƒ«æ™‚ã«è©•ä¾¡ã•ã‚Œã‚‹.

ã¡ãªã¿ã«`quote`ã‚’ä½¿ã‚ãšã«å®Ÿéš›ã«ASTã‚’è¨˜è¿°ã™ã‚‹ã“ã¨ã‚‚ã§ãã‚‹ãŒå†—é•·ã«ãªã‚‹ã€‚ä»¥ä¸‹ã®`1 + 1`ã®ASTã‚’å–ã‚Šå‡ºã™ã‚³ãƒ¼ãƒ‰ã‚’è¦‹æ¯”ã¹ãŸã‚‰ä¸€ç›®ç­ç„¶ã ã‚ã†.

```scala

val exprUsingQuote = `{1 + 1}

// scala 2ç³»ã®å ´åˆã¯ q"1 + 1"

val expr = Apply(Select(Literal(Constant(1)), TermName("+")), List(Literal(Constant(1))))
```

ã¾ãŸ`quote`ã‚’ä½¿ãˆã°ASTã«å¯¾ã—ã¦ãƒ‘ã‚¿ãƒ¼ãƒ³ãƒãƒƒãƒã§ãã‚‹.å¬‰ã—ã„ã§ã™ã­ğŸ˜Š


ã•ã¦ã€JavaScriptã§ã¯å¯¾è±¡ã¨ãªã‚‹Nodeã‚’æ¢ã™ãŸã‚ã«`visitor`ã¨ã„ã†æ¦‚å¿µã‚’ä½¿ã£ãŸãŒã€
Scalaã§ã¯ã“ã®`quote`,`splicing`,ãƒ‘ã‚¿ãƒ¼ãƒ³ãƒãƒƒãƒã‚’ä½¿ã£ã¦ASTã«å¯¾ã™ã‚‹å‡¦ç†ã‚’è¨˜è¿°ã—ã¦ã„ã.


ä¾‹ãˆã°`println("hello world!")`ã®Exprã¯

```scala

`{println("hello world")} 
// #=> println("hello world")ã®Expr

```

ã¨ã„ã†é¢¨ã«æŠœãã ã›ã‚‹.



é€†ã«`Expr`ã‚’ã‚³ãƒ¼ãƒ‰ã®ä¸­ã«åŸ‹ã‚è¾¼ã‚€å ´åˆã¯æ¬¡ã®ã‚ˆã†ã«ã™ã‚‹. 
ä»¥ä¸‹ã®ã‚³ãƒ¼ãƒ‰ã¯exprã®ä¸­èº«ã‚’å‡ºåŠ›ã™ã‚‹ã‚³ãƒ¼ãƒ‰ã«å¤‰æ›ã•ã‚Œã‚‹.

```scala

def printAnyExpr(expr:Expr[Any])(using QuoteContext) =
  '{ println(${Expr(expr.show)}) }

// expr ãŒ `{x + y} ã®ã¨ã "x.+(y)"ãŒè¡¨ç¤ºã•ã‚Œã‚‹. 
```

### å®Ÿéš›ã«ãƒã‚¯ãƒ­ã‚’æ›¸ã„ã¦ã¿ã‚‹

å¼•æ•°ã¨ã—ã¦æ¸¡ã•ã‚ŒãŸã‚³ãƒ¼ãƒ‰ã‚’è©³ç´°ã«è¡¨ç¤ºã™ã‚‹debugSingleãƒã‚¯ãƒ­ã‚’æ›¸ã„ã¦ã¿ã‚‹ã€‚

æœŸå¾…ã•ã‚Œã‚‹æŒ™å‹•ã¯ä»¥ä¸‹ã®ã‚ˆã†ã«ãªã‚‹.

```scala
val x = 1
val y = 1
debugSingle(x+y)
// #=> "Value of x.+(y) is 2"
```

ã¾ãšã€Scala3 ã§ã¯ã‚³ãƒ³ãƒ‘ã‚¤ãƒ«æ™‚ã«è©•ä¾¡ã•ã‚Œã‚‹ãƒã‚¯ãƒ­ã«ã¯`inline`å¥ã‚’ä»˜ã‘ã‚‹ã¨ã„ã†ãƒ«ãƒ¼ãƒ«ãŒã‚ã‚‹ã€‚

ã¾ãŸã€ãƒã‚¯ãƒ­ã®å®Ÿè£…ã«ã¯`QuoteContext`ã¨ã„ã†implicit parameterãŒå¿…è¦ã«ãªã‚‹.

```scala
inline def debugSingle(inline expr:Any):Unit = ${ debugSingleImpl('expr) }

private def debugSingleImpl(expr:Expr[Any])(using q: QuoteContext):Expr[Unit] = ???

```

`???`ã¯Scalaã®ä¾¿åˆ©ãªè¨˜æ³•ã§æœªå®šç¾©ã®å‡¦ç†ã®ä»£ã‚ã‚Šã«ãŠã‘ã‚‹ã€‚Nothingã¨åŒç­‰ã€‚å‘¼ã³å‡ºã™ã¨`NotImplementedException`ã«ãªã‚‹ã€‚

`debugSingleImpl`ã®å¼•æ•°ã«ã‚ã‚‹`using`ã¯Scalaï¼’ç³»ã®implicit parameterã¨åŒã˜.

Scala3ã§ã¯implicitã¯,æš—é»™ã®å¼•æ•°ã«ã¯`using`ã€å‹ã‚¯ãƒ©ã‚¹ã®å®šç¾©ã«ã¯`given`ã€å‹ã‚¯ãƒ©ã‚¹ã®æ¢ç´¢ã®`implicitly`ã¯`summon`ã«ãƒªãƒãƒ¼ãƒ ã•ã‚ŒãŸ.

`debugSIngleImpl`ã®å®Ÿè£…ã¯ã“ã‚“ãªæ„Ÿã˜ã«ãªã‚‹. `expr.show`ã¯ã‚³ãƒ¼ãƒ‰ã‚’è¿”ã™ã®ã§ãã®`Expr`ã‚’å†åº¦å–å¾—ã—ã¦`splicing`ã—ã¦ã„ã‚‹ã€‚

```scala
private def debugSingleImple(expr:Expr[Any])(using q:QuoteContext) :Expr[Unit] =
  `{ println("Value of "+ ${Expr(expr.show)} + "is" + $expr  ) }
```

ã“ã“ã¾ã§ã¯[å…¬å¼ã®ãƒãƒ¥ãƒ¼ãƒˆãƒªã‚¢ãƒ«](https://blog.softwaremill.com/starting-with-scala-3-macros-a-short-tutorial-88e9d2b2584c)ã®
å—ã‘å£²ã‚Šãªã®ã§ä»Šåº¦ã¯Scala3ã®æ–°æ©Ÿèƒ½ã‚’ã¤ã‹ã„ã¤ã¤ãƒã‚¯ãƒ­ã‚’è‡ªä½œã—ã¦ã¿ã‚‹ã€‚(æ›¸ã„ã¦ã‹ã‚‰ã“ã®å‡¦ç†ãªã‚‰ãƒã‚¯ãƒ­ä½¿ã†æ„å‘³ã‚ã¾ã‚Šãªã„ã®ã§ã¯ãƒƒï¼ï¼Ÿã£ã¦æ€ã£ãŸãŒ)

æœŸå¾…ã™ã‚‹æŒ™å‹•ã¯æ¬¡ã®ã‚ˆã†ã«ãªã‚‹. ãƒã‚¯ãƒ­ã‚’ã‚¤ãƒ³ãƒãƒ¼ãƒˆã™ã‚‹ã“ã¨ã§ã‚ˆã—ãªã«toJsonãƒ¡ã‚½ãƒƒãƒ‰ã‚’case classã«ã¯ã‚„ã™ã€‚

```scala

case class Box(id:String)
case class Person(id:String,name:String,age:Int,box:Box)

object Main {
  import sample.Macro._
  def main(args:Array[String]) = {
    val box = Box("1")
    val john =Person("id","john",1,box)
    println(Person.toJson)
    // => {"id":"id","name":"jhon","age":1,"box": {"id": "1"}}

  }
}

```

### inlineãªå‹ã‚¯ãƒ©ã‚¹

å‹ã‚¯ãƒ©ã‚¹ã‚‚inlineã§å®šç¾©ã§ãã‚‹.

```scala
  inline given ToJson[Int] {
      override def toJson(a:Int): String = s"$a"
  }
```

### extension

Scala2ç³»ã§implicit conversionã‚’ä½¿ã£ã¦ã„ãŸæ—¢å­˜ã‚¯ãƒ©ã‚¹ã¸ã®ãƒ¡ã‚½ãƒƒãƒ‰è¿½åŠ ã¯`extension`ã§è¡¨ç¾ã§ãã‚‹ã‚ˆã†ã«ãªã£ãŸã€‚

```scala
  extension [T](inline x:T){
    inline def toJson(using jsonizer:ToJson[T]):String = jsonizer.toJson(x)
  }
```


ã‚³ãƒ¼ãƒ‰ã¯ã“ã“ã«ã‚ã‚‹

https://github.com/ItoYo16u/dotty_macro_practices